var identifier_communication,identifier_meeting;var identifier_communication_static,identifier_meeting_static;var status_communication_count=new Array();var status_communication;var heartbeat_handle,heartbeat_handle_time;var heartbeat_command=1;var vtime_base=0,vtime_check=0,vtime_step=1;var control_sound=true;function refresh(){clearTimeout(heartbeat_handle);Messenger().post("接收到刷新指令，页面将在20秒内刷新。");heartbeat_handle=setTimeout("location.reload(true)",20000)}function communication_refresh(){var b=arguments[0]?arguments[0]:false;var a=new Date();identifier_communication=a.getTime();identifier_communication_static=a.getTime();$.ajax({url:"/cheetah/datacontrol/heartbeat/",data:{command:"GetCommunication",number:status_communication},success:function(e,c){if(identifier_communication_static!=identifier_communication){return}if(e.result=="success"){if((e.room.Block==true)&&(e.staff==false)){$("#main_panel #top_panel #Communications .panel-footer input#content").attr("disabled","disabled");$("#main_panel #top_panel #Communications .panel-footer button").attr("disabled","disabled")}else{$("#main_panel #top_panel #Communications .panel-footer input#content").removeAttr("disabled");$("#main_panel #top_panel #Communications .panel-footer button").removeAttr("disabled")}var d=$("#main_panel #top_panel #Communications .panel-body div").height()-$("#main_panel #top_panel #Communications .panel-body").scrollTop();$("#main_panel #top_panel #Communications .panel-heading h3").html(e.room.Name);$("#main_panel #top_panel #Communications .panel-body").html(e.messages);$('[data-toggle="tooltip"]').tooltip();$("#main_panel #top_panel #Communications .panel-body").animate({"scrollTop":$("#main_panel #top_panel #Communications .panel-body div").height()-d},"slow")}else{$("#main_panel #top_panel #Communications .panel-footer input#content").attr("disabled","disabled");$("#main_panel #top_panel #Communications .panel-footer button").attr("disabled","disabled");$("#main_panel #top_panel #Communications .panel-body").html(e.result)}$("#loaddialog").modal("hide")},error:function(){Messenger().post("System error. Page will be upgraded.");refresh()},dataType:"json"})}function meeting_refresh(){identifier_meeting_static=identifier_meeting;$.ajax({url:"/cheetah/datacontrol/heartbeat/",data:{command:"GetMeeting"},success:function(b,a){if(identifier_meeting_static!=identifier_meeting){return}if(b.result=="success"){$("#main_panel #top_panel #Meetings #meeting_list tbody").html(b.meeting)}$("#loaddialog").modal("hide")},error:function(){Messenger().post("System error. Page will be upgraded.");refresh()},dataType:"json"})}function heartbeat(){clearTimeout(heartbeat_handle);$.ajax({url:"/cheetah/datacontrol/heartbeat/",data:{command:"GetHeartBeat"},success:function(c,a){if(c.messages=="REFRESH"){refresh();return}var b=false,d=false;if(heartbeat_command==0){$(c.communication).each(function(e,f){if(f.id==status_communication){$("#main_panel #top_panel #Communications #communication_list a#"+f.name+" #new_message").html("");if(f.count!=status_communication_count[f.id]){communication_refresh();b=true}status_communication_count[f.id]=f.count}if((f.id!=status_communication)&&(f.count!=status_communication_count[f.id])){b=($("#main_panel #top_panel #Communications #communication_list a#"+f.name+" #new_message").length>0)&&($("#main_panel #top_panel #Communications #communication_list a#"+f.name+" #new_message").html()!=f.count-status_communication_count[f.id]);$("#main_panel #top_panel #Communications #communication_list a#"+f.name+" #new_message").html(f.count-status_communication_count[f.id])}else{$("#main_panel #top_panel #Communications #communication_list a#"+f.name+" #new_message").html("")}});if(identifier_meeting!=c.meeting){identifier_meeting=c.meeting;meeting_refresh();d=true}if(!((vtime_base==c.virtualtime.vtime_base)&&(vtime_check==c.virtualtime.vtime_check)&&(vtime_step==c.virtualtime.vtime_step))){vtime_base=c.virtualtime.vtime_base;vtime_check=c.virtualtime.vtime_check;vtime_step=c.virtualtime.vtime_step}}if(heartbeat_command==1){$("#main_panel #top_panel #Communications #communication_list a #new_message").html("");$(c.communication).each(function(e,f){status_communication_count[f.id]=f.count;if(f.id==status_communication){communication_refresh()}});heartbeat_handle=setTimeout("heartbeat()",3000);if(identifier_meeting!=c.meeting){identifier_meeting=c.meeting;meeting_refresh()}if(!((vtime_base==c.virtualtime.vtime_base)&&(vtime_check==c.virtualtime.vtime_check)&&(vtime_step==c.virtualtime.vtime_step))){vtime_base=c.virtualtime.vtime_base;vtime_check=c.virtualtime.vtime_check;vtime_step=c.virtualtime.vtime_step}}if(heartbeat_command==2){$(c.communication).each(function(e,f){if(f.id==status_communication){$("#main_panel #top_panel #Communications #communication_list a#"+f.name+" #new_message").html("");if(f.count!=status_communication_count[f.id]){communication_refresh()}status_communication_count[f.id]=f.count}})}if(b){Messenger().post("收到新消息。")
}if(d){Messenger().post("收到meeting更新。")}if(b|d){if(control_sound){$("#chatAudio")[0].play()}}heartbeat_command=0;heartbeat_handle=setTimeout("heartbeat()",3000)},error:function(){Messenger().post("System error. Page will be upgraded.");refresh()},dataType:"json"})}function communication_fresh(a){$("#loaddialog").modal("show");clearTimeout(heartbeat_handle);$("#main_panel #top_panel #Communications .list-group a").removeClass("active");$("#main_panel #top_panel #Communications .list-group a#communication_btn_"+a).addClass("active");$("#main_panel #top_panel #Communications .panel-heading h3").html("Loading");$("#main_panel #top_panel #Communications .panel-body").html("Loading");status_communication=a;status_communication_count[status_communication]=-1;if(heartbeat_command==0){heartbeat_command=2}heartbeat()}function meeting_change(c,b,a){$.ajax({url:"/cheetah/datacontrol/meeting/",data:{command:"PostChange",user_number:c,number:b,accept:a,csrfmiddlewaretoken:$("#main_panel #top_panel #Communications #form_communication_send [name='csrfmiddlewaretoken']").val()},success:function(e,d){if(e.result=="success"){$("#loaddialog").modal("show");heartbeat()}else{alert("失败："+e.result)}},dataType:"json",type:"POST"})}function startTime(){function b(e){if(e<10){e="0"+e}return e}function d(k){var j=k.getFullYear();var l=k.getMonth()+1;var i=k.getDate();var g=k.getHours();var e=k.getMinutes();var f=k.getSeconds();l=b(l);i=b(i);e=b(e);f=b(f);return j+"-"+l+"-"+i+" "+g+":"+e+":"+f}clearTimeout(heartbeat_handle_time);var a=new Date();var c=new Date();c.setTime((a.getTime()-vtime_base)*vtime_step+vtime_check);$("#main_panel #top_panel #Communications #time_panel p").html("Real: "+d(a)+"<br/>Vitual: "+d(c));$("#main_panel #top_panel #Settings #setting_time_status").html("Real: "+d(a)+"<br/>Vitual: "+d(c)+"<br/>BaseTime: "+vtime_base+"<br/>VitualBaseTime: "+vtime_check+"<br/>TimeStep: "+vtime_step);heartbeat_handle_time=setTimeout("startTime()",100)}$(function(){$.backstretch(["/static/umunc_cheetah/image/bg_1.jpg","/static/umunc_cheetah/image/bg_2.jpg","/static/umunc_cheetah/image/bg_3.jpg",],{fade:1000,duration:7000});$("#loaddialog").modal({keyboard:false,backdrop:"static",show:false,});Messenger.options={extraClasses:"messenger-fixed messenger-on-top messenger-on-right",theme:"air"};var date=new Date();$(".form_datetime").val(date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()+" "+date.getHours()+":"+date.getMinutes());$(".form_datetime").datetimepicker({format:"yyyy-mm-dd hh:ii",todayHighlight:true,todayBtn:true,autoclose:true});$("#myModal,#setting_time_modal").on("show.bs.modal",function(){$("body").scrollTop(0)});$("#main_panel #top_panel #Communications #form_communication_send").submit(function(){if($("#main_panel #top_panel #Communications #form_communication_send input#content").val()=="FROM:… TO:…"){alert("Please type something.");return false}$("#main_panel #top_panel #Communications .panel-footer input#content").attr("disabled","disabled");$("#main_panel #top_panel #Communications .panel-footer button").attr("disabled","disabled");$.ajax({url:"/cheetah/datacontrol/communication/",data:{command:"PostSend",number:status_communication,system:$("#main_panel #top_panel #Communications #form_communication_send input#system").prop("checked"),content:$("#main_panel #top_panel #Communications #form_communication_send input#content").val(),csrfmiddlewaretoken:$("#main_panel #top_panel #Communications #form_communication_send [name='csrfmiddlewaretoken']").val()},success:function(data,status){if(data.result=="success"){$("#main_panel #top_panel #Communications #form_communication_send input#content").val("FROM:… TO:…");heartbeat_command=2;heartbeat()}else{alert("发送失败："+data.result)}},dataType:"json",type:"POST"});return false});$("#form_communication_send_all").submit(function(){$.ajax({url:"/cheetah/datacontrol/communication/",data:{command:"PostSendAll",content:$("#form_communication_send_all #content").val(),csrfmiddlewaretoken:$("#main_panel #top_panel #Communications #form_communication_send [name='csrfmiddlewaretoken']").val()},success:function(data,status){if(data.result=="success"){alert("成功执行");$("#form_communication_send_all *").removeAttr("disabled");$("#form_communication_send_all #content").val("");$("#communication_send_all_modal").modal("hide");heartbeat()}else{alert("发送失败："+data.result);$("#form_communication_send_all *").removeAttr("disabled")}},dataType:"json",type:"POST"});$("#form_communication_send_all *").attr("disabled","disabled");return false});$("#main_panel #top_panel #Communications #block").click(function(){$.ajax({url:"/cheetah/datacontrol/communication/",data:{command:"PostBlock",number:status_communication,csrfmiddlewaretoken:$("#main_panel #top_panel #Communications #form_communication_send [name='csrfmiddlewaretoken']").val()},success:function(data,status){if(data.result=="success"){heartbeat_command=2;heartbeat()}else{alert("失败："+data.result)}},dataType:"json",type:"POST"});return false
});$("#form_meeting_send").submit(function(){$.ajax({url:"/cheetah/datacontrol/meeting/",data:{command:"PostSend",host:$("#form_meeting_send #host").val(),to:$("#form_meeting_send #to").val(),location:$("#form_meeting_send #location").val(),description:$("#form_meeting_send #description").val(),time:$("#form_meeting_send #time").val(),csrfmiddlewaretoken:$("#main_panel #top_panel #Communications #form_communication_send [name='csrfmiddlewaretoken']").val()},success:function(data,status){if(data.result=="success"){$("#form_meeting_send *").removeAttr("disabled");$("#form_meeting_send #location").val("");$("#form_meeting_send #description").val("");$("#myModal").modal("hide");$("#loaddialog").modal("show");heartbeat()}else{alert("发送失败："+data.result);$("#form_meeting_send *").removeAttr("disabled")}},dataType:"json",type:"POST"});$("#form_meeting_send *").attr("disabled","disabled");return false});$("#form_setting_time").submit(function(){function getDate(strDate){var date=eval("new Date("+strDate.replace(/\d+(?=-[^-]+$)/,function(a){return parseInt(a,10)-1}).match(/\d+/g)+")");return date}if(isNaN($("#form_setting_time #timestep").val())){alert("请输入数字！");return false}$.ajax({url:"/cheetah/datacontrol/setting/",data:{command:"Time",BaseTime:getDate($("#form_setting_time #basetime").val()).getTime(),VirtualBaseTime:getDate($("#form_setting_time #virtualbasetime").val()).getTime(),TimeStep:$("#form_setting_time #timestep").val(),csrfmiddlewaretoken:$("#main_panel #top_panel #Communications #form_communication_send [name='csrfmiddlewaretoken']").val()},success:function(data,status){if(data.result=="success"){alert("成功执行");location.reload(true)}else{alert("发送失败："+data.result);$("#form_setting_time *").removeAttr("disabled")}},dataType:"json",type:"POST"});$("#form_setting_time *").attr("disabled","disabled");return false});$("#main_panel #top_panel #Settings #cache_clear_submit").click(function(){$.ajax({url:"/cheetah/datacontrol/setting/",data:{command:"ClearRefresh",csrfmiddlewaretoken:$("#main_panel #top_panel #Communications #form_communication_send [name='csrfmiddlewaretoken']").val()},success:function(data,status){if(data=="success"){alert("成功执行");location.reload(true)}else{alert("失败："+data.result)}},type:"POST"});return false});$("#main_panel #top_panel #Settings #frontend_refresh_submit").click(function(){$.ajax({url:"/cheetah/datacontrol/setting/",data:{command:"FrontendRefresh",csrfmiddlewaretoken:$("#main_panel #top_panel #Communications #form_communication_send [name='csrfmiddlewaretoken']").val()},success:function(data,status){if(data=="success"){alert("成功执行");location.reload(true)}else{alert("失败："+data.result)}},type:"POST"});return false});$("#form_file_send").submit(function(handle){$(this).ajaxSubmit({beforeSubmit:function(){var filepath=$("#form_file_send #file").val();var extStart=filepath.lastIndexOf(".");var ext=filepath.substring(extStart,filepath.length).toLowerCase();if(ext!=".pdf"&&ext!=".doc"&&ext!=".docx"){alert("Only PDF/DOC/DOCX file will be accepted.");return false}$("#form_file_send *").attr("disabled","disabled");$("#form_file_send #upload_submit").html("Uploading……")},success:function(data){if(data.result=="success"){alert("上传成功。");$("#form_file_send #url").html("Success! Click here to download.");$("#form_file_send #url").attr("href",data.url)}else{alert("失败："+data.result)}$("#form_meeting_send *").removeAttr("disabled");$("#form_file_send #upload_submit").html("Send")},error:function(data){alert("上传发生错误！请刷新页面或联系我们。");$("#form_meeting_send *").removeAttr("disabled");$("#form_file_send #upload_submit").html("Send")},dataType:"json"});return false});$("#control_sound").click(function(){control_sound=!control_sound;if(control_sound){$("#control_sound").html("关闭声音")}else{$("#control_sound").html("开启声音")}});startTime();$("#main_panel #top_panel #Communications .list-group a:first").click();if($("#communication_list").parent().height()>$("#Communications .panel").height()){$("#Communications .panel .panel-body").css("height",$("#communication_list").parent().height()-121)}$("body").append('<audio id="chatAudio"><source src="/static/umunc_cheetah/sound/notify.mp3" type="audio/mpeg"><source src="/static/umunc_cheetah/sound/notify.wav" type="audio/wav"></audio>')});